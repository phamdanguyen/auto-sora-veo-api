# UniAI-Video-Core / Uni-Video Project Context

**Generated by Agent on 2026-01-06**

## 1. Project Overview

**Uni-Video Automation** is a backend system designed to automate video generation and downloading using the **Sora** platform. It exposes a REST API via FastAPI and uses background workers to handle long-running browser automation tasks via Playwright.

## 2. Architecture

### Tech Stack

- **Framework:** FastAPI (`app/main.py`)
- **Database:** SQLAlchemy (SQLite by default)
- **Automation:** Playwright (`SoraDriver`)
- **Concurrency:** Python `asyncio` with Semaphores
- **Templating:** Jinja2 (Dashboard)

### Key Components

#### 2.1 Worker System (`app/core/worker_v2.py`)

The system uses a custom `TaskManager` based worker to handle jobs.

- **Generate Worker:** Processes `generate` tasks. Uses `SoraDriver` to login and create videos. Handles `QuotaExhaustedException` by switching accounts.
- **Download Worker:** Processes `download` tasks. Downloads video files from URLs.
- **Concurrency:** constrained by `MAX_CONCURRENT_GENERATE` (3) and `MAX_CONCURRENT_DOWNLOAD` (3).

#### 2.2 Data Models (`app/models.py`)

- `Account`: Stores credentials (email, password, proxy, cookies) and status (`live`, `die`, `limit_reached`).
- `Job`: Represents a video creation request (`prompt`, `status`, `video_url`).
- `Setting`: System configuration.

#### 2.3 Drivers

- `SoraDriver`: Encapsulates Playwright logic for interacting with the Sora web interface.

## 3. Current Status & Known Issues

### Recent Concurrency Review

A review (`docs/concurrency_review.md`) identified several issues:

- **CRITICAL:** Global Semaphore in `third_party_downloader.py` needs lazy initialization.
- **FIXED:** Filename collisions fixed with UUID.
- **SAFE:** Directory creation and file writing are thread-safe.
- **OPTIMIZATION:** Recommended lowering `MAX_CONCURRENT_DOWNLOAD` to match third-party limits (Fixed in `worker_v2.py`).

### Workflow

1. API receives a job request.
2. Job is added to `task_manager` queue.
3. Worker picks up job, selects an available `Account`.
4. `SoraDriver` performs automation.
5. Result is saved to `data/downloads`.
6. Job marked as completed.

## 4. Agent Notes

- The "User Rules" regarding SuperChat/Odoo/n8n appear to be from a larger system context and are not directly present in this specific repository (`UniAI-Video-Core/uni-video`).
- Focus is on ensuring the stability of the automation worker and proper concurrency handling.
